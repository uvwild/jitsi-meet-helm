apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ include "jitsi-meet.name-jvb" . }}-vs
  namespace: {{ .Values.namespace }}
  labels:
{{ include "jitsi-meet.labels" . | indent 4 }}
spec:
  hosts:
  - {{ .Values.webHost }}
  gateways:
  - {{ include "jitsi-meet.name-jvb" . }}-gw
# video bridge
  tcp:
# iterate over replica and assing different ports
{{- $root := . }}
{{- $name := include "jitsi-meet.name-jvb" $root }}
{{- range $index, $nbr := until (.Values.prosody.replicaCount | int) }}
{{- $target := printf "%s-%d" $name $nbr}}
{{- $udpport := printf "%d" (add $root.Values.jvb.baseport $nbr) }}
{{- $tcpport := printf "%d" (add $root.Values.jvb.baseport $root.Values.jvb.tcpoffset $nbr) }}
  - match:
    - port:  {{ atoi $udpport }}
    route:
    - destination:
        host: {{ $target }}
        port:
          number: {{ atoi $udpport }}

  - match:
    - port: {{ atoi $tcpport }}
    route:
    - destination:
        host: {{ $target }}
        port:
          number: {{ atoi $tcpport }}
  - match:
    - port: {{ $root.Values.jvb.udpport }}
    route:
    - destination:
        host: {{ $target }}
        port:
          number: {{ $root.Values.jvb.udpport }}
  
  - match:
    - port: {{ $root.Values.jvb.tcpport }}
    route:
    - destination:
        host: {{ $target }}
        port:
          number: {{ $root.Values.jvb.tcpport }}
{{- end }}
